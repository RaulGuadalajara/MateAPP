<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Numera (App de Mates)</title>
    <!-- 1. Cargamos Tailwind CSS para que se vea bien sin esfuerzo -->
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 font-sans p-8">

    <div class="max-w-3xl mx-auto bg-white rounded-lg shadow-lg p-8">

        <!-- Título de la App -->
        <h1 class="text-4xl font-bold text-center text-blue-700 mb-8">
            Numera (App de Mates)
        </h1>
        <p class="text-center text-gray-600 mb-8">
            Frontend: HTML + JS Tradicional | Backend: Python (Flask)
        </p>

        <!-- 2. Contenedor para los Temas -->
        <div class="mb-8">
            <h2 class="text-2xl font-semibold mb-4">Temas Disponibles</h2>
            <div id="topics-list" class="flex flex-wrap gap-4">
                <!-- Los botones de temas se cargarán aquí con JavaScript -->
                <p class="text-gray-500">Cargando temas...</p>
            </div>
        </div>

        <!-- 3. Contenedor para los Ejercicios -->
        <div>
            <h2 class="text-2xl font-semibold mb-4">Ejercicios</h2>
            <div id="exercises-list" class="space-y-6">
                <!-- Los ejercicios se cargarán aquí -->
            </div>
        </div>

        <!-- 4. Contenedor para el Feedback (Resultado) -->
        <div id="feedback-message" class="mt-8 p-6 rounded-lg hidden">
            <!-- El resultado de la evaluación irá aquí -->
        </div>

    </div>

    <!-- 5. SCRIPT DE JAVASCRIPT VAINILLA -->
    <script>
        // --- ¡CONFIGURACIÓN IMPORTANTE! ---
        // Pega aquí la URL de tu API de Python desplegada en Render
        const API_URL = "https://app-matematicas-api.onrender.com"; 
        // (Asegúrate de que sea tu URL real)

        // --- Selectores de Elementos ---
        const topicsList = document.getElementById('topics-list');
        const exercisesList = document.getElementById('exercises-list');
        const feedbackMessage = document.getElementById('feedback-message');

        // --- Lógica de la Aplicación ---

        // 1. Se ejecuta cuando la página carga
        window.addEventListener('DOMContentLoaded', () => {
            fetchTopics();
        });

        // 2. Trae la lista de temas desde la API de Python
        async function fetchTopics() {
            try {
                const response = await fetch(`${API_URL}/topics`);
                const topics = await response.json();

                topicsList.innerHTML = ''; // Limpiamos el mensaje "Cargando..."

                // Creamos un botón por cada tema
                topics.forEach(topic => {
                    const button = document.createElement('button');
                    button.textContent = topic.title;
                    button.className = "px-6 py-3 rounded-full font-medium transition-all duration-200 hover:bg-blue-200 bg-gray-200 text-gray-800";
                    
                    // Al hacer clic, cargamos los ejercicios de ese tema
                    button.onclick = () => fetchExercises(topic.id); 
                    
                    topicsList.appendChild(button);
                });

            } catch (error) {
                topicsList.innerHTML = `<p class="text-red-500">Error al cargar temas. ¿Está la API corriendo en ${API_URL}?</p>`;
                console.error("Error en fetchTopics:", error);
            }
        }

        // 3. Trae los ejercicios para un tema específico
        async function fetchExercises(topicId) {
            try {
                const response = await fetch(`${API_URL}/topics/${topicId}/exercises`);
                const exercises = await response.json();

                exercisesList.innerHTML = ''; // Limpiamos ejercicios anteriores
                feedbackMessage.classList.add('hidden'); // Ocultamos feedback anterior

                exercises.forEach(ex => {
                    const exerciseDiv = document.createElement('div');
                    exerciseDiv.className = "bg-gray-50 p-6 rounded-lg shadow-inner";
                    
                    // Contenido del ejercicio
                    exerciseDiv.innerHTML = `
                        <p class="text-2xl font-mono mb-6">${ex.question} = ?</p>
                        <input id="answer-input-${ex.id}" type="text" class="w-full p-4 border rounded-lg text-lg" placeholder="Escribe tu respuesta aquí (ej. x=5)">
                        <button id="eval-button-${ex.id}" class="w-full mt-4 bg-green-500 text-white p-4 rounded-lg font-semibold text-lg hover:bg-green-600 transition">
                            Evaluar Respuesta
                        </button>
                    `;

                    exercisesList.appendChild(exerciseDiv);

                    // Añadimos el listener al botón de evaluar
                    const evalButton = document.getElementById(`eval-button-${ex.id}`);
                    const answerInput = document.getElementById(`answer-input-${ex.id}`);

                    evalButton.onclick = () => evaluateAnswer(ex.id, answerInput.value);
                });

            } catch (error) {
                exercisesList.innerHTML = `<p class="text-red-500">Error al cargar ejercicios.</p>`;
                console.error("Error en fetchExercises:", error);
            }
        }

        // 4. Llama al "Motor de Evaluación" en la API de Python
        async function evaluateAnswer(exerciseId, userAnswer) {
            try {
                const response = await fetch(`${API_URL}/evaluate`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        exercise_id: exerciseId,
                        user_answer: userAnswer,
                    }),
                });

                const result = await response.json();

                // Mostramos el feedback
                feedbackMessage.classList.remove('hidden');
                
                if (result.is_correct) {
                    feedbackMessage.className = "mt-8 p-6 rounded-lg bg-green-100 text-green-800";
                } else {
                    feedbackMessage.className = "mt-8 p-6 rounded-lg bg-red-100 text-red-800";
                }

                // El "Motor de Evaluación" nos da los pasos
                const stepsHtml = result.explanation_steps.map(step => `<p>${step}</p>`).join('');
                feedbackMessage.innerHTML = `
                    <h3 class="text-xl font-semibold mb-2">Resultado:</h3>
                    ${stepsHtml}
                `;

            } catch (error) {
                feedbackMessage.innerHTML = `<p class="text-red-500">Error al evaluar la respuesta.</p>`;
                console.error("Error en evaluateAnswer:", error);
            }
        }

    </script>
</body>
</html>
